{% extends 'base.html' %}
{% load form_extras %}


{% block title %}
Item
{% endblock title %}

{% block content %}

<main class="min-h-screen flex flex-col gap-8 p-4 md:p-6 lg:p-8 w-full mt-16 bg-gray-50 dark:bg-gray-900" id="main">

    <!-- Single Toast Container for All Messages -->
    <div class="toast toast-end toast-top fixed z-50 mt-15" id="toast-container">
        {% for message in messages %}
        <div class="alert {{ message.tags|default:'alert-success' }} {% if message.tags == 'error' %}bg-red-600{% else %}bg-green-600{% endif %} text-white shadow-xl">
            <span class="font-semibold flex items-center gap-2">
                {% if message.tags == 'error' %}
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                {% else %}
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                {% endif %}
                {{ message }}
            </span>
        </div>
        {% endfor %}
    </div>
    


    <!-- Header Section with Gradient - Always Visible -->
    <div class="relative pt-4">
        <h1 class="text-3xl md:text-4xl font-bold mb-2 bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 bg-clip-text text-transparent">
            Add Categories
        </h1>
        <div class="mb-3">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Examples of Common categories:</p>
            <div class="flex flex-wrap gap-2">
                <span class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-full dark:bg-blue-900 dark:text-blue-300">clothing</span>
                <span class="px-2 py-1 text-xs bg-pink-100 text-pink-700 rounded-full dark:bg-pink-900 dark:text-pink-300">sports</span>
                <span class="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded-full dark:bg-purple-900 dark:text-purple-300">grocery</span>
                <span class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded-full dark:bg-gray-700 dark:text-gray-300">electronics</span>
                <span class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-full dark:bg-blue-900 dark:text-blue-300">kitchen </span>
                <span class="px-2 py-1 text-xs bg-pink-100 text-pink-700 rounded-full dark:bg-pink-900 dark:text-pink-300">beauty</span>
            </div>
        </div>
        <div class="h-1 w-20 bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 rounded-full"></div>
    </div> 

    <!-- Main Content - Single Column Layout -->
    <div class="flex flex-col gap-6 lg:gap-8 max-w-7xl w-full mx-auto">
        
        <!-- Form Section -->
        <div class="w-full">
            <div class="card bg-white dark:bg-gray-800 shadow-xl border border-gray-200 dark:border-gray-700 hover:shadow-2xl transition-shadow duration-300">
                <div class="card-body p-6 md:p-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-2 text-gray-800 dark:text-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Add Category
                    </h2>
                    
                    <form id="add-item-form" action="" method="post">
                        {% csrf_token %}
                        <div class="flex flex-col gap-4">
                            <div class="grid grid-cols-1 lg:grid-cols-[1fr_auto] gap-4 items-start">
                                <fieldset class="fieldset w-full">
                                    <label class="block mb-2" for="{{ form.name.id_for_label }}">
                                        <span class="text-base font-semibold text-gray-700 dark:text-gray-300">{{form.name.label}}</span>
                                    </label>
                                    {{ form.name|add_class:"input input-bordered w-full bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:border-blue-500 dark:focus:border-blue-400 text-gray-900 dark:text-gray-100 transition-all duration-200 h-12" }}
                                </fieldset>
                                
                                <button type="submit" class="btn bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white border-0 gap-2 shadow-lg hover:shadow-xl transition-all duration-200 h-12 px-8 whitespace-nowrap lg:mt-10.5">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                    </svg>
                                    Add Category
                                </button>
                            </div>
                            
                            <ul class="mt-0">
                                {% for error in form.name.errors %}
                                <li class="text-red-600 dark:text-red-400 text-sm flex items-center gap-1 mt-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    {{ error }}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Table Section -->
        <div class="w-full">
            <div class="card bg-white dark:bg-gray-800 shadow-xl border border-gray-200 dark:border-gray-700 hover:shadow-2xl transition-shadow duration-300">
                <div class="card-body p-6 md:p-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-2 text-gray-800 dark:text-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600 dark:text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                        </svg>
                        Categories List
                    </h2>
                    
                    <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
                        <table class="table w-full">
                            <thead>
                                <tr class="bg-gray-100 dark:bg-gray-700">
                                    <th class="rounded-tl-lg text-gray-700 dark:text-gray-300">SN</th>
                                    <th class="text-gray-700 dark:text-gray-300">Category Name</th>
                                    <th class="text-gray-700 dark:text-gray-300">Barcode</th>
                                    <th class="rounded-tr-lg text-center text-gray-700 dark:text-gray-300">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="item-list">
                                {% for item in item_list %}
                                <tr id="item-{{ item.id }}" class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150 border-b border-gray-200 dark:border-gray-700">
                                    <th class="font-semibold text-gray-800 dark:text-gray-200">{{ forloop.counter }}</th>
                                    <td class="font-medium text-gray-700 dark:text-gray-300">{{ item.name }}</td>
                                    <td class="font-mono text-sm text-gray-600 dark:text-gray-400">{{ item.barcode }}</td>
                                    <td>
                                        <div class="flex gap-2 justify-center flex-wrap">
                                            <a class="btn btn-sm bg-blue-600 hover:bg-blue-700 text-white border-0 gap-1 shadow hover:shadow-md transition-all duration-200" href="{% url 'shop:item_update' item.id %}">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                </svg>
                                                Update
                                            </a>


  
                                           
                                            <form action="{% url 'shop:price' %}">
                                                <input type="hidden" name="item_id" value="{{item.id}}">
                                                <button class="btn btn-sm bg-emerald-600 hover:bg-emerald-700 text-white border-0 gap-1 shadow hover:shadow-md transition-all duration-200">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                                                    </svg>
                                                    Manage Items
                                                </button>
                                            </form>

                                            <button data-item-id="{{ item.id }}" 
                                                class="btn btn-sm bg-red-600 hover:bg-red-700 text-white border-0 gap-1 shadow hover:shadow-md transition-all duration-200" 
                                                onclick="delete_item(this)">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                                Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center py-12 text-gray-500 dark:text-gray-400">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-3 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                                        </svg>
                                        <p class="text-lg font-medium">No items yet</p>
                                        <p class="text-sm mt-1">Add your first item using the form above!</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

<script>
    // Auto-hide Django messages after 3 seconds
    document.addEventListener('DOMContentLoaded', function() {
        const toastContainer = document.getElementById('toast-container');
        if (toastContainer && toastContainer.children.length > 0) {
            setTimeout(() => {
                toastContainer.innerHTML = '';
            }, 3000);
        }
    });

    function remove_item_from_table(item_id) {
        const row_id_to_be_deleted = `item-${item_id}`;
        const row_to_be_deleted = document.getElementById(row_id_to_be_deleted);
        if (row_to_be_deleted) {
            row_to_be_deleted.style.opacity = '0';
            row_to_be_deleted.style.transform = 'translateX(100px)';
            setTimeout(() => {
                row_to_be_deleted.remove();
                updateRowNumbers();
            }, 300);
        }
    }
    
    function updateRowNumbers() {
        const rows = document.querySelectorAll('#item-list tr');
        rows.forEach((row, index) => {
            const th = row.querySelector('th');
            if (th) {
                th.textContent = index + 1;
            }
        });
    }

    function delete_item(btnElement) {
        const item_id = btnElement.dataset.itemId;

        fetch("{% url 'shop:item_list_delete' 'dummy' %}".replace('dummy', item_id))
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    show_toast_message(data.message, true);
                    remove_item_from_table(item_id);
                } else {
                    show_toast_message("Error: " + data.message, false);
                }
            })
            .catch((err) => console.error(err));
    }

    function show_toast_message(message, success = true) {
        const toastContainer = document.getElementById("toast-container");
        
        // Clear existing toasts
        toastContainer.innerHTML = '';

        // Create new toast
        const toastHTML = `
            <div class="alert ${success ? 'bg-green-600' : 'bg-red-600'} text-white shadow-xl">
                <span class="font-semibold flex items-center gap-2">
                    ${success ? 
                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' : 
                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                    }
                    ${message}
                </span>
            </div>
        `;
        
        toastContainer.innerHTML = toastHTML;
        
        // Auto-remove toast after 3 seconds
        setTimeout(() => {
            toastContainer.innerHTML = '';
        }, 3000);
    }

    function add_item_to_table(item) {
        const table_body = document.getElementById("item-list");
        
        // Remove "no items" row if it exists
        const emptyRow = table_body.querySelector('tr td[colspan="4"]');
        if (emptyRow) {
            emptyRow.parentElement.remove();
        }
        
        const rows_count = table_body.children.length;
        const table_row = document.createElement("tr");
        table_row.id = `item-${item.id}`;
        table_row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150 border-b border-gray-200 dark:border-gray-700";
        table_row.style.opacity = '0';
        table_row.style.transform = 'translateY(-20px)';

        table_row.innerHTML = `
            <th class="font-semibold text-gray-800 dark:text-gray-200">${rows_count + 1}</th>
            <td class="font-medium text-gray-700 dark:text-gray-300">${item.name}</td>
            <td class="font-mono text-sm text-gray-600 dark:text-gray-400">${item.barcode}</td>
            <td>
                <div class="flex gap-2 justify-center flex-wrap">

                    <a class="btn btn-sm bg-blue-600 hover:bg-blue-700 text-white border-0 gap-1 shadow hover:shadow-md transition-all duration-200"
                       href="/shop/item_list/${item.id}/update/">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414
                                a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Update
                    </a>

                    <form action="/shop/price/">
                        <input type="hidden" name="item_id" value="${item.id}">
                        <button class="btn btn-sm bg-emerald-600 hover:bg-emerald-700 text-white border-0 gap-1 shadow hover:shadow-md transition-all duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                            </svg>
                            Manage Items
                        </button>
                    </form>

                    <button data-item-id="${item.id}"
                        class="btn btn-sm bg-red-600 hover:bg-red-700 text-white border-0 gap-1 shadow hover:shadow-md transition-all duration-200"
                        onclick="delete_item(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138
                                21H7.862a2 2 0 01-1.995-1.858L5
                                7m5 4v6m4-6v6m1-10V4a1 1 0
                                00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Delete
                    </button>
                </div>
            </td>
        `;

        table_body.appendChild(table_row);
        
        // Animate in
        setTimeout(() => {
            table_row.style.transition = 'all 0.3s ease';
            table_row.style.opacity = '1';
            table_row.style.transform = 'translateY(0)';
        }, 10);
    }

    document
        .getElementById("add-item-form")
        .addEventListener("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const csrf_token = document.getElementsByName("csrfmiddlewaretoken")[0].value;
            
            fetch("{% url 'shop:item_list' %}", {
                method: "POST",
                headers: { "X-CSRFToken": csrf_token },
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        show_toast_message(data.message, true);
                        add_item_to_table(data.data);
                        this.reset(); // Clear the form after successful submission
                    } else {
                        show_toast_message("Error: " + data.message, false);
                    }
                })
                .catch((err) => console.error(err));
        });
</script>

<style>
    #item-list tr {
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
</style>

{% endblock content %}